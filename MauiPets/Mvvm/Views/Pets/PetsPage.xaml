<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MauiPets.Mvvm.Views.Pets.PetsPage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:resx="clr-namespace:MauiPets.Resources.Languages"
             xmlns:models="clr-namespace:MauiPetsApp.Core.Application.ViewModels;assembly=MauiPets.Core"
             xmlns:local="clr-namespace:MauiPets.Mvvm.ViewModels.Pets"
             xmlns:converters="clr-namespace:MauiPets.Converters"
             x:DataType="local:PetViewModel"
             Title="Daisy Pets"
             x:Name="PetsPageRoot">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:IdadeConverter x:Key="IdadeConverter" />
            <converters:GenderConverter x:Key="GenderConverter" />

            <Style x:Key="MediumLabelBold" TargetType="Label">
                <Setter Property="FontSize" Value="13"/>
                <Setter Property="FontAttributes" Value="Bold"/>
            </Style>
            <Style x:Key="MediumLabel" TargetType="Label">
                <Setter Property="FontSize" Value="13"/>
                <Setter Property="FontAttributes" Value="None"/>
            </Style>
            <Style x:Key="MediumBlueLabelBold" TargetType="Label">
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="FontAttributes" Value="Italic"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="Blue"/>
            </Style>
            <Color x:Key="LightBackground">#FAF9F8</Color>
            <Color x:Key="DarkBackground">Black</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem Command="{Binding AddPetCommand}" IconImageSource="add.png" />
    </ContentPage.ToolbarItems>

    <AbsoluteLayout>
        <Grid AbsoluteLayout.LayoutBounds="0,0,1,1" AbsoluteLayout.LayoutFlags="All">
            <ScrollView>
                <VerticalStackLayout>
                    <Grid RowDefinitions="Auto, Auto, Auto, *">
                        <Border Grid.Row="0" Margin="5, 5"  
                                StrokeShape="RoundRectangle 0,0,50,50" 
                                StrokeThickness="0" HeightRequest="160">
                            <Border.Shadow>
                                <Shadow Brush="Black" Offset="-10,20" Radius="30" Opacity="0.4" />
                            </Border.Shadow>
                            <Image Margin="5, 5"
                                   WidthRequest="250" 
                                   HeightRequest="200" Aspect="Fill"                    
                                   Source="daisypetsbing_min.png"/>
                        </Border>
                        
                        <!-- Filter by Situation -->
                        <Border Grid.Row="1" Margin="12, 10, 12, 5"  
                                StrokeShape="RoundRectangle 10" 
                                Stroke="LightGray"
                                StrokeThickness="1" 
                                Padding="10, 5">
                            <VerticalStackLayout Spacing="5">
                                <Label Text="{resx:Localize Key=TituloFiltrarPorSituacao}" 
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="DarkGray"/>
                                <Picker ItemsSource="{Binding Situations}"
                                        SelectedItem="{Binding SelectedSituation}"
                                        ItemDisplayBinding="{Binding Descricao}"
                                        FontSize="14"
                                        TextColor="Black"
                                        HorizontalOptions="Fill"/>
                            </VerticalStackLayout>
                        </Border>

                        <BoxView Grid.Row="2"
                             HeightRequest="1"
                             BackgroundColor="#E0E0E0"
                             HorizontalOptions="Fill"
                             VerticalOptions="Center"
                             Margin="12,8,12,8" />
                        
                        <CollectionView Grid.Row="3" 
                                        ItemsSource="{Binding Pets}" 
                                        SelectionMode="Single">
                            <CollectionView.EmptyView>
                                <StackLayout Grid.ColumnSpan="2">
                                    <Image HorizontalOptions="Center"
                                           HeightRequest="160"
                                           Margin="0, 40, 0, 0"                                          
                                           WidthRequest="160"
                                           Source="nopets.png"
                                           VerticalOptions="Center" />
                                    <Label Text="{resx:Localize Key=Titulo_NoPets}" 
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           FontFamily="NotoSerifBold"
                                           HorizontalOptions="Center" 
                                           Margin="0, 20, 0, 0"/>
                                </StackLayout>
                            </CollectionView.EmptyView>
                            <CollectionView.ItemsLayout>
                                <GridItemsLayout Orientation="Vertical" Span="2" 
                                                 HorizontalItemSpacing="10"
                                                 VerticalItemSpacing="10" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:PetVM">
                                    <VerticalStackLayout Margin="15, 30, 15, 0">
                                        <Border Stroke="Black" 
                                                StrokeThickness="2" 
                                                HeightRequest="140" 
                                                WidthRequest="160" 
                                                StrokeShape="RoundRectangle 20" 
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center">
                                            <Border.Shadow>
                                                <Shadow Brush="Black" Offset="-5,5" Radius="10" Opacity="0.4" />
                                            </Border.Shadow>
                                            
                                            <Image Source="{Binding Foto}"
                                                   Aspect="AspectFill" 
                                                   HorizontalOptions="Fill"
                                                   VerticalOptions="Fill"
                                                   Margin="5, 0" />
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type local:PetViewModel}}, Path=DisplayPetCommand}"
                                                    CommandParameter="{Binding .}"/>
                                            </Border.GestureRecognizers>
                                        </Border>
                                        <Label Text="{Binding Nome}"
                                               TextColor="Magenta"
                                               Padding="10"
                                               FontSize="18"
                                               HorizontalTextAlignment="Center" />
                                        
                                        <!-- Situation Badge -->
                                        <Border Stroke="DarkBlue" 
                                                StrokeThickness="1" 
                                                StrokeShape="RoundRectangle 15"
                                                BackgroundColor="#E3F2FD"
                                                Padding="10, 5"
                                                Margin="10, 5"
                                                HorizontalOptions="Center">
                                            <Label Text="{Binding SituacaoAnimal}"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   TextColor="DarkBlue"
                                                   HorizontalTextAlignment="Center" />
                                        </Border>

                                        <Grid RowDefinitions="*, *" ColumnDefinitions="*, *">
                                            <Border Grid.Row="0" Grid.Column="0" Stroke="LightGray" StrokeThickness="1" 
                                                    StrokeShape="RoundRectangle 5" Margin="5,1" Padding="5, 1">
                                                <VerticalStackLayout>
                                                    <Label Text="{resx:Localize Key=TituloSexo}"  FontAttributes="Bold"
                                                           FontFamily="PoppinsBold"
                                                           FontSize="10" TextColor="DarkGray" HorizontalTextAlignment="Center"/>
                                                    <Label Text="{Binding Genero, Converter={StaticResource GenderConverter}}"
                                                           FontSize="11" TextColor="Black"
                                                           HorizontalTextAlignment="Center" />
                                                </VerticalStackLayout>
                                            </Border>
                                            <Border Grid.Row="0" Grid.Column="1" Stroke="LightGray" StrokeThickness="1" 
                                                    StrokeShape="RoundRectangle 5" Margin="5, 1" Padding="5, 2">
                                                <VerticalStackLayout>
                                                    <Label Text="{resx:Localize Key=TituloIdade}" FontAttributes="Bold"
                                                           FontFamily="PoppinsBold"
                                                           FontSize="10" TextColor="DarkGray" HorizontalTextAlignment="Center" />
                                                    <Label Text="{Binding DataNascimento, Converter={StaticResource IdadeConverter}}"
                                                           FontSize="11" TextColor="Black" 
                                                           HorizontalTextAlignment="Center" />
                                                </VerticalStackLayout>
                                            </Border>
                                            <Border Grid.Row="1" Grid.ColumnSpan="2" Stroke="LightGray" StrokeThickness="1" 
                                                    StrokeShape="RoundRectangle 5" Padding="5, 2">
                                                <VerticalStackLayout>
                                                    <Label Text="{resx:Localize Key=Pet_Breed}" FontAttributes="Bold"
                                                           FontFamily="PoppinsBold"
                                                           HorizontalTextAlignment="Center"
                                                           FontSize="10" TextColor="DarkGray" />
                                                    <Label Text="{Binding RacaAnimal}"
                                                           FontSize="11" TextColor="Black" 
                                                           HorizontalTextAlignment="Center" />
                                                </VerticalStackLayout>
                                            </Border>
                                        </Grid>
                                        <Button Text="{resx:Localize Key=TituloGaleriaFotos}"
                                                Command="{Binding Source={x:Reference PetsPageRoot}, Path=BindingContext.OpenGalleryCommand}"
                                                CommandParameter="{Binding Id}"
                                                Margin="0,5"
                                                BackgroundColor="#C5E1A5"
                                                TextColor="Black"
                                                FontSize="13"
                                                HorizontalOptions="Center"/>

                                    </VerticalStackLayout>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>
                    <Grid HorizontalOptions="Center" VerticalOptions="Center" Grid.RowSpan="4">
                        <ActivityIndicator                
                            IsRunning="{Binding IsBusy}" 
                            HorizontalOptions="Center" 
                            VerticalOptions="Center" 
                            BackgroundColor="Transparent"
                            Color="Black"/>
                    </Grid>
                </VerticalStackLayout>
            </ScrollView>
        </Grid>

        <!-- Sino e badge flutuantes um pouco mais para a esquerda -->
        <Grid
    AbsoluteLayout.LayoutBounds="0.93,0,50,50" 
            AbsoluteLayout.LayoutFlags="PositionProportional">
            <!-- Ãcone do sino -->
            <Image Source="bell.png"
                       WidthRequest="32"
                       HeightRequest="32"
                       VerticalOptions="Start"
                       HorizontalOptions="End"
                       Margin="0,2,7,0">
                <Image.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding OpenNotificationsCommand}" />
                </Image.GestureRecognizers>
            </Image>
            <!-- Badge sobreposto -->
            <Frame
                IsVisible="{Binding HasUnreadNotifications}"
                CornerRadius="10"
                BackgroundColor="Red"
                Padding="0"
                HasShadow="False"
                HorizontalOptions="End"
                VerticalOptions="Start"
                HeightRequest="20"
                WidthRequest="20"
                TranslationX="8" 
                TranslationY="2">
            
                <Label
                        Text="{Binding UnreadNotificationsCount}"
                        TextColor="White"
                        FontSize="12"
                        HorizontalTextAlignment="Center"
                        VerticalTextAlignment="Center"
                        VerticalOptions="Center"
                        HorizontalOptions="Center"/>
            </Frame>
        </Grid>
    </AbsoluteLayout>
</ContentPage>